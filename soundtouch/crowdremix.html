<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Time And Pitch Audio Player</title>
    <meta name="description" content="Speed up or slow down audio with the PULSE Time Stretcher and Pitch Shifter tool">
    <meta name="author" content="ZVK">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="./scripts/soundtouch.js"></script>
    <!--[if lt IE 9]>
	  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	  <![endif]-->
    <!--mobile theme-->
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <!-- Custom Styles -->
    <link href="./embed.css" rel="stylesheet">
</head>

<body onload="init()">
    <div id="main_wrapper">
        <div class="row">
            <div class="controls">
                <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                    <button id="play_button" onclick="pressButton('play')" class="btn btn-primary-outline">
                        <i class="glyphicon glyphicon-play"></i>
                    </button>
                    <button id="pause_button" onclick="pressButton('pause')" class="btn btn-primary-outline">
                        <i class="glyphicon glyphicon-pause"></i>
                    </button>
                </div>
                <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                    <button id="stop_button" onclick="pressButton('stop')" class="btn btn-primary-outline">
                        <i class="glyphicon glyphicon-stop"></i>
                    </button>
                </div>
            </div>
            <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
                <div id="tempo_wrapper">
                    <label for="tempo_slider"></label>
                    <input type="range" name="tempo_slider" id="tempo_slider" min="0.5" max="1.5" step="0.05" value="1.0" highlight="true" onchange="setTempo(this.value)" />
                </div>
                <br>
                <span id="tempo_value"></span>
            </div>
            <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
                <div id="pitch_wrapper">
                    <label for="pitch_slider"></label>
                    <input type="range" name="pitch_slider" id="pitch_slider" min="-12" max="12" step="1" value="0" highlight="true" onchange="setPitch(this.value)" />
                </div>
                <br>
                <span id="pitch_value"></span>
            </div>
            <div class="col-xs-1 col-sm-1 col-md-1 col-lg-1">
                <button id="reset" onclick="resetSliders()" class="btn btn-primary-outline">
                    reset
                </button>
            </div>
        </div>
    </div>
    <script type='text/javascript'>
    var audioBuffer = null,
	    context = new AudioContext(),
    	node, st;
    var GLOBAL_ACTIONS = {
        'play': function() {
            if (current_state !== state.playing && current_state !== state.init) {
                current_state = state.playing;
                source = new soundtouch.WebAudioBufferSource(audioBuffer)
                filter = new soundtouch.SimpleFilter(source, st);
                filter.sourcePosition = source_position;
                node = soundtouch.getWebAudioNode(context, filter);
                node.connect(context.destination);
                console.log("playing");
                setAttributes($('#play_button')[0], {"style": "display:none"});
                setAttributes($('#pause_button')[0], {"style": "display:block"});
            }
        },
        'pause': function() {
            if (current_state === state.playing) {
                current_state = state.paused;
                //wavesurfer.backend.source.stop(0);
                current_time = wavesurfer.getCurrentTime();
                source_position = filter.sourcePosition;
                node.disconnect();
                console.log("paused");
                setAttributes($('#pause_button')[0], {"style": "display:none"});
                setAttributes($('#play_button')[0], {"style": "display:block"});
            }
        },
        'stop': function(){
            if (current_state === state.playing) {
                current_state = state.stopped;
                //wavesurfer.backend.source.stop(0);
                node.disconnect();
                //wavesurfer.stop();
                current_time = 0;
                setAttributes($('#pause_button')[0], {"style": "display:none"});
                setAttributes($('#play_button')[0], {"style": "display:block"});
                
            }
            if (current_state === state.paused) {
                current_state = state.stopped;
                wavesurfer.stop();
                current_time = 0;
            }
        }
    },
    state = {
        init: 0,
        ready: 1,
        playing: 2,
        paused: 3,
        stopped: 4
    },
    source_position = 0,
    current_time = 0,
    current_state = state.init;
    /*
	 * AUDIO TRANSPORT BUTTONS
	 */
	function pressButton(action){
	    if (action) GLOBAL_ACTIONS[action]();
	}
    /*
     * SOUNDTOUCH-JS DATA SETTERS
     */
    function setTempo(speed) {
        console.log("setting speed to " + speed);
        st.tempo = speed;
        //document.getElementById("tempo_value").innerHTML = parseInt(speed*bpm)+" BPM";
        document.getElementById("tempo_value").innerHTML = parseInt(speed * 100) + "% speed";
    }

    function setPitch(semitones) {
        //calculate factor to multiply frequency by
        let frequency_factor = Math.pow(2, (semitones / 12));
        console.log("setting pitch to " + frequency_factor + "% (" + semitones + " halfsteps)");
        st.pitch = frequency_factor;
        if (semitones > 0) {
            document.getElementById("pitch_value").innerHTML = "+" + semitones + " half steps";
        } else if (semitones < 0) {
            document.getElementById("pitch_value").innerHTML = semitones + " half steps";
        } else {
            document.getElementById("pitch_value").innerHTML = "original pitch"
        }
    }
    function resetSliders(){
        $('#tempo_slider')[0].value = 1.0;
        $('#pitch_slider')[0].value = 0;
        setTempo(1.0);
        setPitch(0);
    }
	//function to set a batch of attributes for an HTML element and object pair
	function setAttributes(element, attributes) {
	    for (attribute in attributes) {
	        element.setAttribute(attribute, attributes[attribute]);
	    }
	    return element;
	}
    function init() {
    	//Enable tempo slider, pitch slider, play/pause button
		function enableControls(){
			
		    // reset a tempo slider
		    setAttributes($("#play_button")[0],{"style": "display:block"});
		    setAttributes($("#stop_button")[0],{"style": "display:block"});
		}
        function load(url) {

            function loadSound(url) {
                let request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.responseType = 'arraybuffer';

                function onError(e) {
                    console.log(e)
                }
                // Decode asynchronously
                request.onload = function() {
                    let sample_rate = 44100;
                    context.decodeAudioData(request.response, function(buffer) {
                        audioBuffer = buffer;
                        st = new soundtouch.SoundTouch(sample_rate);
                        //filter = new soundtouch.SimpleFilter(audioBuffer, st);
                        //node = soundtouch.getWebAudioNode(context, filter);
                        setPitch(0);
                        setTempo(1);
                        current_state = state.ready;
                        enableControls();
                    }, onError);
                }
                request.send();
            }
            loadSound(url);
        }
        let f_name = './audio/crazy.mp3';
        console.log(f_name);
        load(f_name);
    }
    </script>
</body>

</html>